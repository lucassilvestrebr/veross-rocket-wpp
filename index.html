<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rocketflow by Veross</title>
  <meta name="color-scheme" content="light only" />
  <style>
    :root{
      --navy:#080A30;
      --gold:#ae8a56;
      --sand:#ecd7b4;
      --gray:#cdcdd0;
      --paper:#fcfcfc;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, #cbd0ff33 0%, transparent 60%),
        radial-gradient(1200px 600px at 120% 10%, #f6e6cc55 0%, transparent 60%),
        var(--paper);
      color:#1a1a1a;
      display:flex;flex-direction:column;align-items:center;
    }

    /* CARD base */
    .card{
      width:min(520px,60vw);
      background:#fff;
      border:1px solid #00000014;
      border-radius:20px;
      box-shadow:
        0 14px 38px -14px rgba(8,10,48,.22),
        0 6px 18px -10px rgba(8,10,48,.16),
        inset 0 1px 0 rgba(255,255,255,.65);
      padding:34px 34px 28px;
      margin:32px 0 10px;
    }
    .divider{
      height:1px;
      background:linear-gradient(90deg,transparent,#00000016,transparent);
      margin:20px 0;
    }

    /* BRAND central */
    .brand{
      text-align:center;
      margin-top:4px;
    }
    .brand img{
      width:min(260px,48vw); height:auto; object-fit:contain;
      filter: drop-shadow(0 6px 20px rgba(8,10,48,.12));
    }
    .brand h1{
      margin:10px 0 0; font-size:40px; line-height:1; letter-spacing:.2px;
      color:var(--navy); font-weight:800;
    }
    .brand .tagline{
      margin-top:10px; color:#465; font-size:15px;
    }

    /* FORM */
    h2{margin:18px 0 8px; color:var(--navy); font-size:22px}
    label{display:block; margin:12px 0 8px; font-weight:700; color:#222}
    input[type="email"],input[type="password"],input[type="text"],textarea{
      width:100%; font-size:16px;
      padding:14px 14px; border:1px solid #00000022; border-radius:12px; background:#fff;
      outline:none; transition:.15s border,.15s box-shadow;
    }
    textarea{min-height:120px; resize:vertical}
    input:focus,textarea:focus{
      border-color:#3b82f622; box-shadow:0 0 0 4px #3b82f611;
    }
    .row{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    @media (max-width:740px){ .row{grid-template-columns:1fr} }

    /* BUTTONS */
    .actions{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:12px}
    .btn{appearance:none; border:0; cursor:pointer; padding:12px 18px; border-radius:12px;
         font-weight:800; font-size:15px; transition:.15s filter,.15s transform}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn-primary{background:var(--navy); color:#fff}
    .btn-gold{background:var(--gold); color:#fff}
    .btn-ghost{background:#f6f7fb; color:#222; border:1px solid #00000012}
    .muted{color:#666}
    .right{margin-left:auto}

    /* APP (pós-login) */
    .hide{display:none!important}
    a.layout{color:var(--navy); text-decoration:none; border-bottom:1px dashed var(--navy)}

    /* Rodapé */
    .footer{margin:10px 0 34px; color:#555; font-size:14px; text-align:center}
  </style>
</head>
<body>

  <!-- LOGIN (card centralizado, como no print) -->
  <section id="card-login" class="card">
    <div class="brand">
      <img src="https://i.postimg.cc/28y5rD7J/LOGO-VEROSS-ROCKETFLOW-1000-X1000.png" alt="Rocketflow" />
      <div class="tagline">Faça prospecção todo santo dia!</div>
    </div>

    <h2>Acesse sua conta</h2>

    <div class="row">
      <div>
        <label for="email">E-mail</label>
        <input id="email" type="email" placeholder="voce@empresa.com" autocomplete="email" />
      </div>
      <div>
        <label for="senha">Senha</label>
        <input id="senha" type="password" placeholder="••••••••" autocomplete="current-password" />
      </div>
    </div>

    <div class="actions">
      <button id="btnCriarConta" class="btn btn-gold" type="button">Criar conta</button>
      <button id="btnEntrar" class="btn btn-primary" type="button">Entrar</button>
      <span class="muted">Use o mesmo e-mail para criar e entrar.</span>
      <span id="loginStatus" class="right muted"></span>
    </div>

    <div class="divider"></div>
    <div class="divider"></div>
  </section>

  <!-- APP (pós-login) -->
  <section id="card-app" class="card hide">
    <div class="brand" style="margin-bottom:6px">
      <img src="https://i.postimg.cc/28y5rD7J/LOGO-VEROSS-ROCKETFLOW-1000-X1000.png" alt="" style="width:90px" />
      <div class="tagline" style="margin-top:6px">Logado como <strong id="user-email">—</strong></div>
    </div>

    <h2>Campanha</h2>

    <label for="nomeCampanha">Nome da campanha</label>
    <input id="nomeCampanha" type="text" placeholder="Ex.: Abertura Setembro" />

    <label for="objetivoCampanha">Objetivo da campanha</label>
    <input id="objetivoCampanha" type="text" placeholder="Ex.: Geração de leads B2B" />

    <label for="mensagemCampanha">Mensagem da campanha</label>
    <textarea id="mensagemCampanha">Oi, [[nome]]! Aqui é da Veross 🚀 — posso te enviar uma ideia rápida?</textarea>
    <div class="muted" style="margin-top:6px">Use [[nome]] para personalizar com o nome da lista.</div>

    <div class="divider"></div>

    <div class="actions">
      <a class="layout" href="data:text/csv;charset=utf-8,nome,telefone%0A" download="layout_contatos.csv">Baixar layout (nome,telefone)</a>
      <span class="muted">A lista é lida da planilha padrão no Google Sheets.</span>
      <button id="btnIniciar" class="btn btn-primary right" type="button">Iniciar campanha</button>
      <button id="btnSair" class="btn btn-ghost" type="button">Sair</button>
    </div>
  </section>

  <div class="footer">
    Veross 🚀 B2Bzando | Utilize com responsabilidade.
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- App script -->
  <script>
    // 🔐 Credenciais públicas do projeto
    const SUPABASE_URL  = "https://zrsofdqppbvxzhiwnzzr.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpyc29mZHFwcGJ2eHpoaXduenpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1OTc5MjUsImV4cCI6MjA3MjE3MzkyNX0.LZNHtXsG5Thkf_6ZRG5-UfAMaIqzOHrSt5UgRsnEaTs";

    // n8n webhook
    const N8N_OUTREACH = "/api/outreach";

    // Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    // Helpers
    const $ = (s)=>document.querySelector(s);
    const show = (el)=>el.classList.remove('hide');
    const hide = (el)=>el.classList.add('hide');

    async function refreshUI(){
      const { data: { session } } = await supabase.auth.getSession();
      if (session){
        hide($("#card-login")); show($("#card-app"));
        $("#user-email").textContent = session.user?.email || "-";
      } else {
        show($("#card-login")); hide($("#card-app"));
        $("#user-email").textContent = "-";
      }
    }

    async function criarConta(){
      await disableDuring(async ()=>{
        const email = $("#email").value.trim();
        const senha = $("#senha").value;
        const { error } = await supabase.auth.signUp({ email, password: senha });
        if (error) return alert("Erro ao criar conta: " + error.message);
        alert("Conta criada! (se exigir confirmação, verifique seu e-mail)");
      }, $("#btnCriarConta"));
    }

    async function entrar(){
      await disableDuring(async ()=>{
        const email = $("#email").value.trim();
        const senha = $("#senha").value;
        const { error } = await supabase.auth.signInWithPassword({ email, password: senha });
        if (error) return alert("Login falhou: " + error.message);
        $("#loginStatus").textContent = "";
        await refreshUI();
      }, $("#btnEntrar"));
    }

    async function sair(){
      await supabase.auth.signOut();
      await refreshUI();
    }

   async function iniciarCampanha(){
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return alert("Faça login primeiro.");

  const payload = {
    nome: ($("#nomeCampanha").value || "").trim() || "Sem nome",
    objetivo: ($("#objetivoCampanha").value || "").trim(),
    message_template: $("#mensagemCampanha").value || "Oi, [[nome]]!",
    token: session.access_token           // ⬅️ token vai no corpo
  };

await disableDuring(async ()=>{
  const res = await fetch(N8N_OUTREACH, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      nome: ($("#nomeCampanha").value || "").trim() || "Sem nome",
      objetivo: ($("#objetivoCampanha").value || "").trim(),
      message_template: $("#mensagemCampanha").value || "Oi, [[nome]]!",
      token: (await supabase.auth.getSession()).data.session?.access_token || ""
    })
  });
  const out = await res.json();
  if (!out.ok) throw new Error(`n8n ${out.status}: ${String(out.body).slice(0,200)}`);
  alert("Campanha iniciada! Acompanhe no n8n.");
}, $("#btnIniciar"));

}

    async function disableDuring(fn, btn){
      const old = btn.textContent;
      btn.disabled = true; btn.textContent = "Aguarde…";
      try{ await fn(); }catch(e){ console.error(e); alert("Ops: " + e.message); }
      finally{ btn.disabled = false; btn.textContent = old; }
    }

    // Eventos
    $("#btnCriarConta").addEventListener("click", criarConta);
    $("#btnEntrar").addEventListener("click", entrar);
    $("#btnSair").addEventListener("click", sair);
    $("#btnIniciar").addEventListener("click", iniciarCampanha);

    // Inicia
    refreshUI();
  </script>
</body>
</html>
